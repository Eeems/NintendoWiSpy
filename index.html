<!DOCTYPE html>
<html>
<body>

<canvas id="myCanvas" width="300" height="200"
	Your browser does not support the canvas element.
</canvas>

<script>
    window.onload = function() {
    
    theme = 'theme\\' + getAllUrlParams().theme + '\\';
    var canvas = document.getElementById("myCanvas");
    var ctx=canvas.getContext("2d");
    var config = JSON.parse(getJSON(theme + 'config.json'));
    
    if (config.button) {
        for (i in config.button) {
            config.button[i].img = new Image();
            config.button[i].img.src = theme + config.button[i].file;
            }
    }
    if (config.analog) {
        for (i in config.button) {
            config.analog[i].img = new Image();
            config.analog[i].img.src = theme + config.analog[i].file;
            }
    }
    if (config.stick) {
        for (i in config.stick) {
            config.stick[i].img = new Image();
            config.stick[i].img.src = theme + config.stick[i].file;
            }
    }
    if (config.background) {
        var imgBackground = new Image();
        imgBackground.src = theme + config.background.file;
    }
    
    
    
    

    var socket = new WebSocket('ws://localhost:13254');
    socket.onopen = function(event) {
        console.log('Connected to: ' + event.currentTarget.url);
    }

    socket.onmessage = function(event){
       // console.log('Recieved: ' + event.data);
       
        var controlsObj = extractControls(event.data);
        ctx.clearRect(0,0,canvas.width,canvas.height)
       
        switch(config.controllerType) {
            case 'GCN':
                for (i in config.button) {
                    if (controlsObj.button[i]) {
                        ctx.drawImage(config.button[i].img,config.button[i].X,config.button[i].Y);
                    
                    }
                }
              //  debugger;
                
                for (i in config.stick) {
                    if (config.stick[i].yname in controlsObj.analog  && config.stick[i].xname in controlsObj.analog) { //If the axis exist
                        var x = ((config.stick[i].xreverse ? -1 : 1) * config.stick[i].xrange);
                        var y = ((config.stick[i].yreverse ? 1 : -1) * config.stick[i].yrange);
                        x *= controlsObj.analog[config.stick[i].xname] 
                        y *= controlsObj.analog[config.stick[i].yname]
                        x +=  + config.stick[i].X;
                        y +=  + config.stick[i].Y;
                        ctx.drawImage(config.stick[i].img,x,y);
                    }else{
                    debugger;}
                }
                break;
            default:
                console.log("No Controller type");
        }
        
    }
    function extractControls(data) {
        //This is a horridly optimized funtion...
        var ret = {};
        ret.button = {}
        ret.analog = {}
        switch(config.controllerType) {
            case 'GCN':
                ret.button.START = Boolean(parseInt(data[3]));
                ret.button.A = Boolean(parseInt(data[7]));
                ret.button.B = Boolean(parseInt(data[6]));
                ret.button.X = Boolean(parseInt(data[5]));
                ret.button.Y = Boolean(parseInt(data[4]));
                ret.button.Z = Boolean(parseInt(data[11]));
                ret.button.L = Boolean(parseInt(data[9]));
                ret.button.R = Boolean(parseInt(data[10]));
                //Todo analog shennangins 
                
                ret.analog.joyX = (getMultiByte(data,16)-128)/128;
                ret.analog.joyY = (getMultiByte(data,16+8)-128)/128;
                ret.analog.cstickX = (getMultiByte(data,16+16)-128)/128;
                ret.analog.cstickY = (getMultiByte(data,16+24)-128)/128;
                ret.analog.lTrig = getMultiByte(data,16+32);
                ret.analog.rTrig = getMultiByte(data,16+40);
                
                break;
            default:
                console.log("No Controller type");
        }
        return ret;
    }
}
 
/*            byte val = 0;
            for (int i = 0 ; i < 8 ; ++i) {
                if ((packet[i+offset] & 0x0F) != 0) {
                    val |= (byte)(1<<(7-i));
                }
            }
            ret
*/
function getMultiByte(data,offset) {
    var val = 0;
    for (var j=0;j<8;++j){
        if (data[j+offset] == '1'){
            val |= 1<<(7-j);
        }
    }
    return val;
}
//Graciously stolen from sitepoint 
//https://www.sitepoint.com/get-url-parameters-with-javascript/
function getAllUrlParams(url) { 

  // get query string from url (optional) or window
  var queryString = url ? url.split('?')[1] : window.location.search.slice(1);

  // we'll store the parameters here
  var obj = {};

  // if query string exists
  if (queryString) {

    // stuff after # is not part of query string, so get rid of it
    queryString = queryString.split('#')[0];

    // split our query string into its component parts
    var arr = queryString.split('&');

    for (var i=0; i<arr.length; i++) {
      // separate the keys and the values
      var a = arr[i].split('=');

      // in case params look like: list[]=thing1&list[]=thing2
      var paramNum = undefined;
      var paramName = a[0].replace(/\[\d*\]/, function(v) {
        paramNum = v.slice(1,-1);
        return '';
      });

      // set parameter value (use 'true' if empty)
      var paramValue = typeof(a[1])==='undefined' ? true : a[1];

      // (optional) keep case consistent
      paramName = paramName.toLowerCase();
      paramValue = paramValue.toLowerCase();

      // if parameter name already exists
      if (obj[paramName]) {
        // convert value to array (if still string)
        if (typeof obj[paramName] === 'string') {
          obj[paramName] = [obj[paramName]];
        }
        // if no array index number specified...
        if (typeof paramNum === 'undefined') {
          // put the value on the end of the array
          obj[paramName].push(paramValue);
        }
        // if array index number specified...
        else {
          // put the value at that index number
          obj[paramName][paramNum] = paramValue;
        }
      }
      // if param name doesn't exist yet, set it
      else {
        obj[paramName] = paramValue;
      }
    }
  }

  return obj;
}

//Stack overflow to the rescue
// needs replacment eventually "deprecated" Bah
function getJSON(url) {
        var resp ;
        var xmlHttp ;

        resp  = '' ;
        xmlHttp = new XMLHttpRequest();

        if(xmlHttp != null)
        {
            xmlHttp.open( "GET", url, false );
            xmlHttp.send( null );
            resp = xmlHttp.responseText;
        }

        return resp ;
    }

</script>

</body>
</html>

